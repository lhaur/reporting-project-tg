{% extends "base.html" %} {% block content %}
<h1 data-fi="Päivittäiset raportit" data-en="Daily Reports">
  Päivittäiset raportit
</h1>
<div class="filter-section">
  <label>
    <input type="checkbox" id="useDateFilter" />
    <span data-fi="Käytä päivämääräsuodatinta" data-en="Use date filter"
      >Käytä päivämääräsuodatinta</span
    >
  </label>

  <div id="dateInputs" style="display: none" class="date-inputs">
    <label for="startDate">
      <span data-fi="Aloituspäivä:" data-en="Start Date:">Aloituspäivä:</span>
      <input type="date" id="startDate" />
    </label>

    <label for="endDate">
      <span data-fi="Lopetuspäivä:" data-en="End Date:">Lopetuspäivä:</span>
      <input type="date" id="endDate" />
    </label>
  </div>
</div>

<button
  id="fetchReports"
  data-fi="Hae päivittäiset raportit"
  data-en="Get Daily Reports"
>
  Hae päivittäiset raportit
</button>

<div id="summary"></div>
<div id="reports"></div>

<script>
  const API_URL = "/api/daily_reports";

  document
    .getElementById("useDateFilter")
    .addEventListener("change", function () {
      document.getElementById("dateInputs").style.display = this.checked
        ? "block"
        : "none";
    });

  document
    .getElementById("fetchReports")
    .addEventListener("click", fetchDailyReports);
  document.addEventListener("DOMContentLoaded", fetchDailyReports);
  async function fetchDailyReports() {
    const useDateFilter = document.getElementById("useDateFilter").checked;
    let params = new URLSearchParams();

    if (useDateFilter) {
      const startDateInput = document.getElementById("startDate").value;
      const endDateInput = document.getElementById("endDate").value;

      if (startDateInput) {
        const startDate = new Date(startDateInput);
        if (!isNaN(startDate.getTime())) {
          startDate.setHours(0, 0, 0, 0);
          params.append("startdate", startDate.toISOString());
        } else {
          document.getElementById("summary").innerHTML =
            document.documentElement.lang === "fi"
              ? "Virheellinen aloituspäivämäärä."
              : "Invalid start date.";
          return;
        }
      }

      if (endDateInput) {
        const endDate = new Date(endDateInput);
        if (!isNaN(endDate.getTime())) {
          endDate.setHours(23, 59, 59, 999);
          params.append("enddate", endDate.toISOString());
        } else {
          document.getElementById("summary").innerHTML =
            document.documentElement.lang === "fi"
              ? "Virheellinen lopetuspäivämäärä."
              : "Invalid end date.";
          return;
        }
      }

      if (!startDateInput && !endDateInput) {
        document.getElementById("summary").innerHTML =
          document.documentElement.lang === "fi"
            ? "Syötä vähintään 1 päivämäärä."
            : "Enter at least 1 date.";
        return;
      }
    }

    try {
      const response = await fetch(`${API_URL}?${params}`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const reports = await response.json();
      displayDailyReports(reports);
    } catch (error) {
      console.error("Error fetching daily reports:", error);
      document.getElementById("summary").innerHTML =
        document.documentElement.lang === "fi"
          ? `Virhe päivittäisten raporttien hakemisessa: ${error.message}`
          : `Error fetching daily reports: ${error.message}`;
    }
  }

  function displayDailyReports(reports) {
    const summaryElement = document.getElementById("summary");
    const reportsElement = document.getElementById("reports");

    if (reports.length > 0) {
      reports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      summaryElement.innerHTML =
        document.documentElement.lang === "fi"
          ? `Yhteensä ${reports.length} päivittäistä raporttia`
          : `Overall ${reports.length} daily reports`;
      reportsElement.innerHTML = reports
        .map((report, index) => {
          const date = new Date(report.timestamp);
          const formattedDate = `${date.getFullYear()}-${String(
            date.getMonth() + 1
          ).padStart(2, "0")}-${String(date.getDate()).padStart(2, "0")}`;
          const summaryHtml = marked.parse(report.summary);
          return `
                        <div class="expander">
                            <div class="expander-header" onclick="toggleExpander(this)">
                                ${
                                  document.documentElement.lang === "fi"
                                    ? "Päivittäinen raportti"
                                    : "Daily Report"
                                } ${formattedDate} (${report.report_count} ${
            document.documentElement.lang === "fi" ? "raporttia" : "reports"
          })
                            </div>
                            <div class="expander-content">
                                <p><strong>${
                                  document.documentElement.lang === "fi"
                                    ? "Yhteenveto"
                                    : "Summary"
                                }:</strong> ${summaryHtml}</p>
                                <p><strong>${
                                  document.documentElement.lang === "fi"
                                    ? "Raporttien määrä"
                                    : "Report Count"
                                }:</strong> ${report.report_count}</p>
                                <p><strong>${
                                  document.documentElement.lang === "fi"
                                    ? "Aloituspäivä"
                                    : "Start Date"
                                }:</strong> ${new Date(
            report.start_date
          ).toLocaleString()}</p>
                                <p><strong>${
                                  document.documentElement.lang === "fi"
                                    ? "Lopetuspäivä"
                                    : "End Date"
                                }:</strong> ${new Date(
            report.end_date
          ).toLocaleString()}</p>
                            </div>
                        </div>
                    `;
        })
        .join("");
    } else {
      summaryElement.innerHTML =
        document.documentElement.lang === "fi"
          ? "Ei päivittäisiä raportteja valitulta ajanjaksolta."
          : "No daily reports for the selected period.";
      reportsElement.innerHTML = "";
    }
  }

  function toggleExpander(header) {
    const content = header.nextElementSibling;
    content.style.display =
      content.style.display === "block" ? "none" : "block";
  }
</script>
{% endblock %}
