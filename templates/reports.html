{% extends "base.html" %} {% block content %}
<h1 data-fi="Raportit" data-en="Reports">Raportit</h1>
<div class="filter-section">
  <label
    data-fi="Käytä päivämääräsuodatinta"
    data-en="Use date filter"
    for="useDateFilter"
  >
    Käytä päivämääräsuodatinta
  </label>
  <input type="checkbox" id="useDateFilter" />

  <div id="dateInputs" style="display: none" class="date-inputs">
    <label for="startDate" data-fi="Aloituspäivä:" data-en="Start Date:">
      Aloituspäivä:
    </label>
    <input type="date" id="startDate" />

    <label for="endDate" data-fi="Lopetuspäivä:" data-en="End Date:">
      Lopetuspäivä:
    </label>
    <input type="date" id="endDate" />
  </div>
</div>

<button id="fetchReports" data-fi="Hae raportit" data-en="Get Reports">
  Hae raportit
</button>

<div id="summary"></div>
<div id="reports"></div>

<script>
  const API_URL = "/api/reports";

  document
    .getElementById("useDateFilter")
    .addEventListener("change", function () {
      document.getElementById("dateInputs").style.display = this.checked
        ? "block"
        : "none";
    });

  document
    .getElementById("fetchReports")
    .addEventListener("click", fetchReports);
  document.addEventListener("DOMContentLoaded", fetchReports);
  async function fetchReports() {
    const useDateFilter = document.getElementById("useDateFilter").checked;
    let params = new URLSearchParams();

    if (useDateFilter) {
      const startDateInput = document.getElementById("startDate").value;
      const endDateInput = document.getElementById("endDate").value;

      if (startDateInput) {
        const startDate = new Date(startDateInput);
        if (!isNaN(startDate.getTime())) {
          startDate.setHours(0, 0, 0, 0);
          params.append("startdate", startDate.toISOString());
        } else {
          document.getElementById("summary").innerHTML =
            document.documentElement.lang === "fi"
              ? "Virheellinen aloituspäivämäärä."
              : "Invalid start date.";
          return;
        }
      }

      if (endDateInput) {
        const endDate = new Date(endDateInput);
        if (!isNaN(endDate.getTime())) {
          endDate.setHours(23, 59, 59, 999);
          params.append("enddate", endDate.toISOString());
        } else {
          document.getElementById("summary").innerHTML =
            document.documentElement.lang === "fi"
              ? "Virheellinen lopetuspäivämäärä."
              : "Invalid end date.";
          return;
        }
      }

      if (!startDateInput && !endDateInput) {
        document.getElementById("summary").innerHTML =
          document.documentElement.lang === "fi"
            ? "Syötä vähintään 1 päivämäärä."
            : "Enter at least 1 date.";
        return;
      }
    }

    try {
      const response = await fetch(`${API_URL}?${params}`);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const reports = await response.json();
      displayReports(reports);
    } catch (error) {
      console.error("Error fetching reports:", error);
      document.getElementById("summary").innerHTML =
        document.documentElement.lang === "fi"
          ? `Virhe raporttien hakemisessa: ${error.message}`
          : `Error fetching reports: ${error.message}`;
    }
  }

  function displayReports(reports) {
    const summaryElement = document.getElementById("summary");
    const reportsElement = document.getElementById("reports");

    if (reports.length > 0) {
      reports.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      summaryElement.innerHTML =
        document.documentElement.lang === "fi"
          ? `Yhteensä ${reports.length} raporttia`
          : `Overall ${reports.length} reports`;
      reportsElement.innerHTML = reports
        .map((report, index) => {
          const date = new Date(report.timestamp);
          const formattedDate = `${date.getFullYear()}-${String(
            date.getMonth() + 1
          ).padStart(2, "0")}-${String(date.getDate()).padStart(
            2,
            "0"
          )} ${String(date.getHours()).padStart(2, "0")}:${String(
            date.getMinutes()
          ).padStart(2, "0")}`;

          return `
                <div class="expander">
                    <div class="expander-header" onclick="toggleExpander(this)">
                        ${
                          document.documentElement.lang === "fi"
                            ? "Raportti"
                            : "Report"
                        } ${report.reportId || index} - ${formattedDate}
                    </div>
                    <div class="expander-content">
                        ${Object.entries(report)
                          .filter(
                            ([key]) => !["reportId", "timestamp"].includes(key)
                          )
                          .map(
                            ([key, value]) => `
                                <p><strong>${key}:</strong> ${
                              typeof value === "object"
                                ? JSON.stringify(value, null, 2)
                                : value
                            }</p>
                            `
                          )
                          .join("")}
                    </div>
                </div>
            `;
        })
        .join("");
    } else {
      summaryElement.innerHTML =
        document.documentElement.lang === "fi"
          ? "Ei raportteja valitulla aikavälillä."
          : "No reports for the selected time period.";
      reportsElement.innerHTML = "";
    }
  }

  function toggleExpander(header) {
    const content = header.nextElementSibling;
    content.style.display =
      content.style.display === "block" ? "none" : "block";
  }
</script>
{% endblock %}
